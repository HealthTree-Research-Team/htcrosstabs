---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# htcrosstabs

<!-- badges: start -->
<!-- badges: end -->

The goal of htcrosstabs is to easily create printable crosstabs from raw data frames.

## Installation

You can install the development version of htcrosstabs like so:

``` r
devtools::install_github("HealthTree-Research-Team/htcrosstabs")
```

And you can load it like so:

``` r
library(htcrosstabs)
```

```{r, include = FALSE}
library(htcrosstabs)
```

# Quick Start

The fast way to create crosstabs is to pass your data frame into `crosstab_stacked()`, telling it if you have a cohort column. Then pass the object into `kbl()`; not the `kableExtra` one, the one that comes with `htcrosstabs`. It works exactly the same way, but applies some automatic formatting like adding auto-generated footnotes and row groupings.

``` r
new_crosstab <- crosstab_stacked(
    iris,
    cohort_col_name = "Species"
)

kbl(new_crosstab)
```

# More Detailed

## Creating a Crosstab

A simple crosstab can be created from a one-column data frame.

```{r}
sports <- sports_by_age[, "sport", drop = FALSE]
head(sports, 5)

new_crosstab <- crosstab(sports)
```

A crosstab can group data into cohorts by providing a two column data frame, one for the data and one for the cohorts. Simply provide the name of the cohort column when creating it.

```{r}
head(sports_by_age, 5)

new_crosstab <- crosstab(sports_by_age, cohort_col_name = "age")
```

## Crosstab Types

Crosstabs can hold multiple data types: categorical, numeric, Likert-like, and multi-response. The data type is automatically determined when you create the crosstab.

Categorical crosstabs are the default data type. Character values, logical values, and factors will all be counted as categorical.

```{r}
head(sports_by_age, 5) # Categorical

new_crosstab <- crosstab(sports_by_age, "age")
```

Numeric crosstabs are the default when the data is numbers.

```{r}
head(length_by_species, 5)

new_crosstab <- crosstab(length_by_species, "species")
```

Likert crosstabs are created when categorical data is provided, along with a named vector to map values to numbers.

```{r}
head(licorice_by_region, 5)

opinion_map <- c("likes" = 1, "neither" = 0, "dislikes" = -1)

new_crosstab <- crosstab(licorice_by_region, "region", var_map = opinion_map)
```

Multi-response crosstabs are created by providing a list-column allowing multiple answers per row. You can nest columns into the proper format with `nest_multi_col()`.

```{r}
head(allergies_by_school, 5)

new_crosstab <- crosstab(allergies_by_school, "school")
```

## Checking and Casting Data Types

You can check the data type and whether it's grouped or not with `is.crosstab.*()` functions.

```{r}
new_crosstab <- crosstab(length_by_species, "species")

is.crosstab.grouped(new_crosstab)
is.crosstab.categorical(new_crosstab)
is.crosstab.numeric(new_crosstab)
is.crosstab.likert(new_crosstab)
is.crosstab.multi(new_crosstab)
```

You can also, if needed, cast one data type to another using the `as.crosstab.*()` functions. The details on how the conversion is done can be found in the man pages by typing `?cast_crosstab`.

```{r}
new_crosstab <- crosstab(licorice_by_region, "region", opinion_map)
is.crosstab.likert(new_crosstab)

new_crosstab <- as.crosstab.num(new_crosstab)
is.crosstab.likert(new_crosstab)
```

## Analysis

You can see the data from the crosstabs by using `data_table()`. Ungrouped data has a dummy cohort column with the name of the final output column.

```{r}
new_crosstab <- crosstab(sports)
data_table(new_crosstab) |> head(5)
```

You can extract useful values with the `get_*()` functions. You can get values like the mean, standard deviation, median, iqr, percentages, counts, etc. A full list is available at the bottom of this page, or in the man pages with `?get_values`.

```{r}
new_crosstab <- crosstab(length_by_species, "species")

get_mean(new_crosstab)

get_complete_total(new_crosstab)
```

There is also a function `join_val()` which lets you quickly and automatically join different variable tables.

```{r}
new_crosstab <- crosstab(length_by_species, "species")

join_val(
    get_complete(new_crosstab),
    get_mean(new_crosstab),
    get_sd(new_crosstab)
)

new_crosstab <- crosstab(sports_by_age, "age")

join_val(
    get_complete(new_crosstab),
    get_count(new_crosstab),
    get_proportion(new_crosstab)
)
```

You can also do statistical analysis quickly, like an ANOVA, chi-square, or Rao-Scott corrected chi-square test with `get_*_p_value()` functions. Post-hocs can be done with the `get_*_posthoc()` functions. Post-hocs return a symmetric data frame/matrix of pairwise p-values, which are by default corrected using the Benjamini-Hochberg correction. You can change the correction method with `method = ...`, or you can disable correction completely with `p.adj = FALSE`.

```{r}
new_crosstab <- crosstab(length_by_species, "species")

get_anova_p_value(new_crosstab)

get_tukey_posthoc(new_crosstab)
```

## Adding Formatted Rows

You can add rows with pre-formatted data by using the `add_*_row()` functions. A full list of functions can be found at the bottom of this page, or in the man pages with `?add_formatted_rows`. You can also extract the rows separate from the crosstab object with the `get_*_row()` functions.

The order of the rows and columns is determined by the factor levels of the input data frame.

```{r}
crosstab(length_by_species, "species") |> 
    add_complete_total_row() |> 
    add_mean_sd_row() |> 
    add_med_q1_q3_row()

crosstab(sports_by_age, "age") |> 
    add_complete_total_row() |> 
    add_count_rows()
```

## Adding Pre-Built Tables

Certain types of data have common types of rows you usually want, so we have preset templates you can use with `add_*_table()`.

```{r}
satisfaction_map <- c("very satisfied" = 3, "somewhat satisfied" = 2, "not satisfied" = 1)
crosstab(satisfaction_by_company, "company", satisfaction_map) |> 
    add_likert_table()

crosstab(allergies_by_school, "school") |> 
    add_categorical_table()
```

You can also choose `add_default_table()` and it will decide automatically based on the data you passed in.

```{r}
crosstab(length_by_species, "species") |> 
    add_default_table()

crosstab(sports_by_age, "age") |> 
    add_default_table()
```

## Stacking Crosstabs

If you want stacked crosstabs, there are two ways to do it:

The first way is to make two crosstabs and manually stack them with `stack_crosstabs()`. You can stack as many as you want.

```{r}
ct1 <- iris[, c("Sepal.Length", "Species")] |> 
    crosstab("Species") |> 
    add_default_table(anova = F)

ct2 <- iris[, c("Petal.Length", "Species")] |> 
    crosstab("Species") |> 
    add_default_table(anova = F)

ct3 <- iris[, c("Sepal.Width", "Species")] |> 
    crosstab("Species") |> 
    add_default_table(anova = F)

ct4 <- iris[, c("Petal.Width", "Species")] |> 
    crosstab("Species") |> 
    add_default_table(anova = F)

stack_crosstabs(ct1, ct2, ct3, ct4)
```

The second is to call `crosstab_stacked()` which runs through a data frame and automatically applies the default table format.

```{r}
crosstab_stacked(iris, "Species", anova = F)
```

If you have two likert columns, you can pass multiple maps into `var_maps` as a list, where the name of the list item is the same as the column name.

```{r}
perception_map <- c(
    "overwhelmingly positive" = 2, 
    "somewhat positive" = 1, 
    "neutral" = 0, 
    "somewhat negative" = -1, 
    "overwhelmingly negative" = -2
)
support_map <- c(
    "very supportive" = 4, 
    "somewhat supportive" = 3, 
    "apathetic" = 2, 
    "somewhat demeaning" = 1, 
    "very demeaning" = 0
)

# Names in map match their respective columns
likert_maps <- list(
    uni_perception = perception_map,
    prof_support = support_map
)

keep_cols <- c("university", "uni_perception", "prof_support")

crosstab_stacked(
    df = students[, keep_cols],
    cohort_col_name = "university",
    var_map = likert_maps,
    anova = F,
    chisq = F
)
```


## Printable Output

The `kableExtra` package contains a lot of good stuff, so I made a wrapper for the `kbl()` function which will recognize a crosstab object and automatically apply formatting such as auto-generated footnotes.

``` r
new_crosstab <- crosstab_stacked(students, "university")

htcrosstabs::kbl(new_crosstab)
```

# Other Utilities

Because 1) the output order of the rows and columns is determined by factor levels, 2) multi-response data is handled in list-columns, and 3) list-columns are a pain to factorize, I included wrappers for `factor()` and `levels()` which include support for list-columns.

```{r}
head(allergies_by_school, 5)

new_allergies <- factor(allergies_by_school$allergies, levels = c("nuts", "eggs", "milk", "gluten"))
levels(new_allergies)
```

I also included a function `default_var_map()` which will automatically generate a likert map based on factor levels.

```{r}
default_var_map(students$prof_support)
```

# Complete Function Index

## Crosstab Creation
``` r
crosstab()         # Create crosstab
as.crosstab()      # Create crosstab (Same as crosstab())
crosstab_stacked() # Create crosstab with rows from multi-column data frame
stack_crosstabs()  # Combine 2+ crosstabs
crosstab_data()    # Create internal data table (you shouldn't need this)
```

## Class attributes
``` r
# GETTERS
var_name()             # The name of the variable column
var()                  # The variable column as a vector
var_levels()           # The factor levels in the variable column
var_map()              # The named numeric vector mapping variable to number (likert)
var_mapped()           # The variable column mapped to its numeric representation
cohort_name()          # The name of the cohort column
cohort()               # The cohort column as a vector
cohort_levels()        # Factor levels in the cohort column
combined_cohort_name() # Name of the combined cohort column in the output
desc_name()            # Name of the leftmost description column in the output
data_table()           # The internal data table containing the original data
get_raw_data()         # The internal data table without combined cohort
index()                # The vector keeping track of row groupings

# SETTERS
# Note that functions with a `<-` at the end are called on the left side of `<-` like this:
# cohort_name(test_ct) <- "new name"
# var_map(test_ct) <- c("agree" = 3, "neither" = 2, "disagree" = 1)

set_new_data()         # Replace data table in current crosstab with a new one
`data_table<-`()       # Replace data table in current crosstab with a new one
`var_name<-`()         # Rename the variable column
`var<-`()              # Set new values for the variable column
`var_levels<-`()       # Set new variable factor levels
`var_map<-`()          # Set new numeric values to map the variables to
`cohort_name<-`()      # Rename the cohort column
`cohort<-`()           # Set new values for the cohort column
`cohort_levels<-`()    # Set new cohort factor levels
`index<-`()            # Change the row grouping for the output table
```

## Class Checking
``` r
is.crosstab()                 # Is this a crosstab object? (FALSE if not)
is.crosstab.grouped()         # Is this a grouped crosstab? (FALSE if not)
is.crosstab.categorical()     # Is this a categorical crosstab? (FALSE if not)
is.crosstab.numeric()         # Is this a numeric crosstab? (FALSE if not)
is.crosstab.likert()          # Is this a likert crosstab? (FALSE if not)
is.crosstab.multi()           # Is this a multi-response crosstab? (FALSE if not)
is.crosstab.data()            # Is this an internal crosstab_data table? (FALSE if not)

assert_crosstab()             # Is this a crosstab object? (Errors if not)
assert_crosstab_grouped()     # Is this a grouped crosstab? (Errors if not)
assert_crosstab_categorical() # Is this a categorical crosstab? (Errors if not)
assert_crosstab_numeric()     # Is this a numeric crosstab? (Errors if not)
assert_crosstab_likert()      # Is this a likert crosstab? (Errors if not)
assert_crosstab_multi()       # Is this a multi-response crosstab? (Errors if not)
assert_crosstab_data()        # Is this an internal crosstab_data table? (Errors if not)
```

## Class Casting
``` r
as.crosstab()        # Cast data frame to crosstab
as.crosstab.cat()    # Cast crosstab to categorical
as.crosstab.num()    # Cast crosstab to numeric
as.crosstab.likert() # Cast crosstab to likert
as.crosstab.multi()  # Cast crosstab to multi-response
```

## Get Values
``` r
join_val()           # Quickly join multiple value tables

get_complete()       # Get complete (not NA)
get_total()          # Get total (including NA)
get_complete_total() # Get "complete / total"

get_max()            # Get maximum
get_min()            # Get minimum

get_mean()           # Get mean
get_sd()             # Get standard deviation
get_mean_sd()        # Get "mean +/- sd"

get_med()            # Get median
get_median()         # Get median
get_q1()             # Get first quartile
get_q3()             # Get third quartile
get_q1_q3()          # Get "Q1--Q3"
get_med_q1_q3()      # Get "med (Q1, Q3)"
get_iqr()            # Get IQR
get_iqr_q3_q1()      # Get "IQR (Q3-Q1)"

get_count()          # Get counts
get_prop()           # Get proportions (out of complete)
get_proportion()     # Get proportions (out of complete)
get_count_prop()     # Get "count (proportion)"
get_percent()        # Get percent
get_count_percent()  # Get "count (percent%)"
```

## Get Stats
``` r
get_anova_p_value()     # Get overall ANOVA p-value
get_anova_posthoc()     # Get Tukey post-hoc p-values
get_tukey_posthoc()     # Get Tukey post-hoc p-values

get_chisq_p_value()     # Get overall chi-square p-value
get_chisq_posthoc()     # Get chi-square post-hoc p_values

get_rao_scott_p_value() # Get overall Rao-Scott p-value
get_rao_scott_posthoc() # Get Rao-Scott post-hoc p-values
```

## Get/Add Formatted Rows
``` r
add_rows()               # Add custom rows to the output table

get_complete_row()       # Get formatted complete row
add_complete_row()       # Get formatted complete row
get_total_row()          # Get formatted total row
add_total_row()          # Get formatted total row
get_complete_total_row() # Get formatted "complete / total row"
add_complete_total_row() # Get formatted "complete / total row"

get_mean_row()           # Get formatted mean row
add_mean_row()           # Get formatted mean row
get_sd_row()             # Get formatted standard deviation row
add_sd_row()             # Get formatted standard deviation row
get_mean_sd_row()        # Get formatted "mean +/- sd" row
add_mean_sd_row()        # Get formatted "mean +/- sd" row

get_med_row()            # Get formatted median row
add_med_row()            # Get formatted median row
get_median_row()         # Get formatted median row
add_median_row()         # Get formatted median row
get_q1_row()             # Get formatted Q1 row
add_q1_row()             # Get formatted Q1 row
get_q3_row()             # Get formatted Q3 row
add_q3_row()             # Get formatted Q3 row
get_q1_q3_row()          # Get formatted "Q1--Q3" row
add_q1_q3_row()          # Get formatted "Q1--Q3" row
get_med_q1_q3_row()      # Get formatted "med (Q1, Q3)" row
add_med_q1_q3_row()      # Get formatted "med (Q1, Q3)" row
get_iqr_row()            # Get formatted IQR row
add_iqr_row()            # Get formatted IQR row
get_iqr_q3_q1_row()      # Get formatted "IQR (Q3-Q1)" row
add_iqr_q3_q1_row()      # Get formatted "IQR (Q3-Q1)" row

get_count_rows()         # Get formatted count rows
add_count_rows()         # Get formatted count rows
get_prop_rows()          # Get formatted proportion rows
add_prop_rows()          # Get formatted proportion rows
get_proportion_rows()    # Get formatted proportion rows
add_proportion_rows()    # Get formatted proportion rows
get_count_prop_rows()    # Get formatted "count (proportion)" rows
add_count_prop_rows()    # Get formatted "count (proportion)" rows
get_percent_rows()       # Get formatted percent rows
add_percent_rows()       # Get formatted percent rows
get_count_percent_rows() # Get formatted "count (percent%)" rows
add_count_percent_rows() # Get formatted "count (percent%)" rows

get_anova_rows()         # Get formatted ANOVA rows
add_anova_rows()         # Get formatted ANOVA rows
get_chisq_rows()         # Get formatted chi-square rows
add_chisq_rows()         # Get formatted chi-square rows
get_rao_scott_rows()     # Get formatted Rao-Scott rows
add_rao_scott_rows()     # Get formatted Rao-Scott rows
```

## Add Pre-Built Tables
``` r
add_default_table()     # Guess which table based on the data type

add_categorical_table() # Add default categorical table
add_numeric_table()     # Add default numeric table
add_likert_table()      # Add default likert table
```

## Kable Extensions
``` r
kbl()             # Wrapper for kableExtra::kbl(), automatically applies formatting

apply_footnotes() # Manually apply footnotes (automatically called by kbl())
apply_pack_rows() # Manually apply row groups (automatically called by kbl())
apply_table_sep() # Manually apply lines between tables (automatically called by kbl())
```

## Miscellaneous Utilities
``` r
factor()          # Wrapper for base::factor(), supports lists
levels()          # Wrapper for base::levels(), supports lists
`levels<-`()      # Wrapper for base::`levels<-`(), supports lists
is.factorlist()   # Is this a list of factor objects?

default_var_map() # Create a default likert map based on factor levels

nest_multi_col()  # Nest column into proper multi-response form
to_long()         # Pivot data from formatted row format to long format
to_wide()         # Pivot data from 3-column long (description, cohort, variable) to formatted row
```
